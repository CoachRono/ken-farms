<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ken Farms Tea Portal - Executive Edition</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1b5e20">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-green: #1b5e20;
            --light-bg: #f0f4f1;
            --white: #ffffff;
            --blue: #0d47a1;
            --money: #2e7d32;
            --accent: #81c784;
            --danger: #d32f2f;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--light-bg); margin: 0; padding: 20px; color: #333; }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary-green); padding-bottom: 10px; }
        header h1 { color: var(--primary-green); margin: 0; font-size: 2.2rem; text-transform: uppercase; letter-spacing: 1px; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card { background: var(--white); padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-top: 6px solid var(--primary-green); }
        .payroll-card { border-top-color: var(--blue); background-color: #e3f2fd; }
        .stat-val { font-weight: bold; color: var(--primary-green); font-size: 1.5rem; }
        .rate-badge { font-size: 0.75rem; background: #e8f5e9; padding: 3px 8px; border-radius: 4px; font-weight: bold; color: var(--primary-green); border: 1px solid var(--accent); }
        
        .main-content { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media (max-width: 950px) { .main-content { grid-template-columns: 1fr; } }

        .section-box { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-box h2 { margin-top: 0; font-size: 1.2rem; color: var(--primary-green); border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; box-sizing: border-box;}
        
        .rate-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .rate-inputs input { padding: 8px; font-weight: bold; text-align: center; }

        button.submit-btn { background: var(--primary-green); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button.pdf-btn { background: var(--blue); color: white; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .worker-tag { display: inline-flex; align-items: center; background: #f0f0f0; padding: 4px 10px; border-radius: 20px; margin: 3px; font-size: 0.8rem; border: 1px solid #ddd; }
        .worker-tag button { border: none; background: none; color: var(--danger); cursor: pointer; font-weight: bold; margin-left: 8px; }

        .search-input { border-radius: 25px; border: 2px solid var(--accent); text-indent: 15px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fdfdfd; color: var(--primary-green); text-transform: uppercase; font-size: 0.75rem; }
        .money-text { font-weight: bold; color: var(--money); }
        .scroll-area { max-height: 500px; overflow-y: auto; }
        
        /* Camera Preview */
        #video-preview { width: 100%; border-radius: 12px; display: none; margin-bottom: 15px; background: #000; }
    </style>
</head>
<body>

<header>
    <h1>üçÉ Ken Farms Manager</h1>
    <p>Official Tea Production & Executive Payroll</p>
</header>

<div class="grid-container">
    <div class="card">
        <h3>Faith Farm</h3>
        <div><span class="stat-val" id="month-faith">0.0</span> kg</div>
        <span class="rate-badge">Ksh <span id="disp-rate-faith">9</span>/kg</span>
    </div>
    <div class="card">
        <h3>Main Farm</h3>
        <div><span class="stat-val" id="month-main">0.0</span> kg</div>
        <span class="rate-badge">Ksh <span id="disp-rate-main">9</span>/kg</span>
    </div>
    <div class="card">
        <h3>Mosore Farm</h3>
        <div><span class="stat-val" id="month-mosore">0.0</span> kg</div>
        <span class="rate-badge">Ksh <span id="disp-rate-mosore">9</span>/kg</span>
    </div>
    <div class="card payroll-card">
        <h3>Grand Payroll</h3>
        <div class="stat-val" style="color:var(--blue)">Ksh <span id="total-payroll">0</span></div>
        <button class="pdf-btn" onclick="generatePDF()" style="margin-top:10px; font-size: 0.85rem; padding: 8px;">üìÑ Export Official PDF</button>
    </div>
</div>

<div class="main-content">
    <div class="sidebar">
        <div class="section-box" style="border-left: 5px solid var(--blue);">
            <h2>1. Worker Registry</h2>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newWorkerName" placeholder="New Name" style="margin-bottom: 0;">
                <button onclick="addWorker()" style="width: 70px; margin-bottom: 0; background: var(--blue); color: white; border: none; font-size: 0.8rem;">Add</button>
            </div>
            <div id="workerList" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;"></div>
        </div>

        <div class="section-box" style="border-left: 5px solid var(--accent);">
            <h2>2. Configure Farm Rates</h2>
            <div class="rate-inputs">
                <div><label>Faith</label><input type="number" id="rate-faith" value="9" onchange="updateRates()"></div>
                <div><label>Main</label><input type="number" id="rate-main" value="9" onchange="updateRates()"></div>
                <div><label>Mosore</label><input type="number" id="rate-mosore" value="9" onchange="updateRates()"></div>
            </div>
        </div>

        <div class="section-box">
            <h2>3. Record Harvest</h2>
            <video id="video-preview" autoplay playsinline></video>
            <form id="harvestForm">
                <label>Select Worker</label>
                <select id="workerDropdown" required><option value="">-- Choose Worker --</option></select>
                <label>Farm Location</label>
                <select id="farmId">
                    <option value="faith">Ken Farm Faith</option>
                    <option value="main">Ken Farm Main</option>
                    <option value="mosore">Mosore</option>
                </select>
                <label>Weight (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="0.0" required>
                <button type="submit" class="submit-btn">Save to Ledger</button>
            </form>
        </div>
    </div>

    <div class="section-box">
        <h2>Production History</h2>
        <input type="text" id="searchInput" class="search-input" onkeyup="filterHistory()" placeholder="Search records...">
        <div class="scroll-area">
            <table id="historyTable">
                <thead>
                    <tr>
                        <th>Date & Worker</th>
                        <th>Farm</th>
                        <th>Rate</th>
                        <th>Kg</th>
                        <th>Earnings</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CAMERA INITIALIZATION (AUTO-OPEN) ---
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const video = document.getElementById('video-preview');
            video.srcObject = stream;
            video.style.display = 'block';
        } catch (err) {
            console.log("Camera access declined or unavailable.");
        }
    }
    window.addEventListener('load', startCamera);

    // --- DATA HANDLING ---
    const DB_KEY = "KEN_FARMS_FINAL_2026_V16";
    const RATE_KEY = "KEN_FARMS_RATE_2026_V16";
    const WORKER_KEY = "KEN_FARMS_WORKERS_2026_V16";

    const initialWorkers = ["Sharon", "Daisy 2", "Chepkoech", "Doreen"];
    let records = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let rates = JSON.parse(localStorage.getItem(RATE_KEY)) || { faith: 9, main: 9, mosore: 9 };
    let workers = JSON.parse(localStorage.getItem(WORKER_KEY)) || initialWorkers;

    function addWorker() {
        const name = document.getElementById('newWorkerName').value.trim();
        if (name && !workers.includes(name)) {
            workers.push(name);
            localStorage.setItem(WORKER_KEY, JSON.stringify(workers));
            document.getElementById('newWorkerName').value = '';
            updateWorkerUI();
        }
    }

    function removeWorker(name) {
        if(confirm(`Remove ${name}?`)) {
            workers = workers.filter(w => w !== name);
            localStorage.setItem(WORKER_KEY, JSON.stringify(workers));
            updateWorkerUI();
        }
    }

    function updateWorkerUI() {
        const listDiv = document.getElementById('workerList');
        const dropdown = document.getElementById('workerDropdown');
        listDiv.innerHTML = '';
        dropdown.innerHTML = '<option value="">-- Choose Worker --</option>';
        workers.sort().forEach(w => {
            listDiv.innerHTML += `<span class="worker-tag">${w} <button onclick="removeWorker('${w}')">√ó</button></span>`;
            const opt = document.createElement('option');
            opt.value = w; opt.textContent = w;
            dropdown.appendChild(opt);
        });
    }

    function updateRates() {
        rates.faith = parseFloat(document.getElementById('rate-faith').value) || 0;
        rates.main = parseFloat(document.getElementById('rate-main').value) || 0;
        rates.mosore = parseFloat(document.getElementById('rate-mosore').value) || 0;
        localStorage.setItem(RATE_KEY, JSON.stringify(rates));
        document.getElementById('disp-rate-faith').innerText = rates.faith;
        document.getElementById('disp-rate-main').innerText = rates.main;
        document.getElementById('disp-rate-mosore').innerText = rates.mosore;
    }

    function render() {
        const historyBody = document.getElementById('historyBody');
        historyBody.innerHTML = '';
        let stats = { faith: 0, main: 0, mosore: 0, totalPay: 0 };
        [...records].reverse().forEach((rec) => {
            stats[rec.farmId] += rec.weight;
            const pay = rec.weight * rec.rateUsed;
            stats.totalPay += pay;
            historyBody.innerHTML += `<tr>
                <td><small>${rec.dateString}</small><br><strong>${rec.name}</strong></td>
                <td>${rec.farmName}</td>
                <td>${rec.rateUsed}/-</td>
                <td>${rec.weight}</td>
                <td class="money-text">Ksh ${pay.toFixed(2)}</td>
                <td><button onclick="deleteRecord(${rec.id})" style="color:red; border:none; background:none; cursor:pointer;">√ó</button></td>
            </tr>`;
        });
        document.getElementById('month-faith').innerText = stats.faith.toFixed(1);
        document.getElementById('month-main').innerText = stats.main.toFixed(1);
        document.getElementById('month-mosore').innerText = stats.mosore.toFixed(1);
        document.getElementById('total-payroll').innerText = stats.totalPay.toLocaleString();
    }

    document.getElementById('harvestForm').onsubmit = function(e) {
        e.preventDefault();
        const fId = document.getElementById('farmId').value;
        records.push({
            id: Date.now(),
            name: document.getElementById('workerDropdown').value,
            farmId: fId,
            farmName: document.getElementById('farmId').options[document.getElementById('farmId').selectedIndex].text,
            weight: parseFloat(document.getElementById('weight').value),
            rateUsed: rates[fId],
            dateString: new Date().toLocaleDateString()
        });
        localStorage.setItem(DB_KEY, JSON.stringify(records));
        render();
        document.getElementById('weight').value = '';
    };

    function deleteRecord(id) {
        if(confirm("Delete record?")) {
            records = records.filter(r => r.id !== id);
            localStorage.setItem(DB_KEY, JSON.stringify(records));
            render();
        }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const totalKg = records.reduce((sum, r) => sum + r.weight, 0);
        const totalPay = records.reduce((sum, r) => sum + (r.weight * r.rateUsed), 0);

        doc.setFontSize(20); doc.setTextColor(27, 94, 32);
        doc.text("KEN FARMS TEA PRODUCTION", 105, 20, { align: "center" });
        
        doc.autoTable({
            startY: 35,
            head: [['Date', 'Worker', 'Farm', 'Rate', 'Weight (kg)', 'Pay (Ksh)']],
            body: records.map(r => [r.dateString, r.name, r.farmName, r.rateUsed, r.weight.toFixed(1), (r.weight*r.rateUsed).toFixed(2)]),
            foot: [['', '', '', 'GRAND TOTALS', `${totalKg.toFixed(1)} kg`, `Ksh ${totalPay.toLocaleString()}`]],
            headStyles: { fillColor: [27, 94, 32] },
            footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' }
        });

        const finalY = doc.lastAutoTable.finalY + 25;
        doc.line(20, finalY, 80, finalY); doc.text("Manager Signature", 20, finalY + 5);
        doc.line(130, finalY, 190, finalY); doc.text("Recipient Signature", 130, finalY + 5);

        doc.save(`Ken_Farms_Report.pdf`);
    }

    document.getElementById('rate-faith').value = rates.faith;
    document.getElementById('rate-main').value = rates.main;
    document.getElementById('rate-mosore').value = rates.mosore;
    updateRates(); updateWorkerUI(); render();
</script>

</body>
</html>

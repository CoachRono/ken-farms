<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ken Farms Tea Portal</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1b5e20">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --primary-green: #1b5e20;
            --light-bg: #f0f4f1;
            --white: #ffffff;
            --blue: #0d47a1;
            --money: #2e7d32;
            --accent: #81c784;
            --danger: #d32f2f;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--light-bg); margin: 0; padding: 20px; color: #333; }
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--primary-green); padding-bottom: 10px; }
        header h1 { color: var(--primary-green); margin: 0; font-size: 2rem; text-transform: uppercase; }
        
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 25px; }
        .card { background: var(--white); padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-top: 5px solid var(--primary-green); }
        .payroll-card { border-top-color: var(--blue); background-color: #e3f2fd; grid-column: span 2; }
        .card h3 { margin: 0 0 5px 0; font-size: 0.7rem; text-transform: uppercase; color: #666; }
        .stat-val { font-weight: bold; color: var(--primary-green); font-size: 1.2rem; }
        .rate-badge { font-size: 0.7rem; color: #666; font-style: italic; }

        .main-content { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        @media (max-width: 950px) { .main-content { grid-template-columns: 1fr; } }

        .section-box { background: var(--white); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .section-box h2 { margin-top: 0; font-size: 1.1rem; color: var(--primary-green); border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        input, select, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1rem; box-sizing: border-box;}
        button.submit-btn { background: var(--primary-green); color: white; border: none; font-weight: bold; cursor: pointer; }
        button.pdf-btn { background: var(--blue); color: white; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .worker-tag { display: inline-block; background: #eee; padding: 4px 10px; border-radius: 15px; margin: 2px; font-size: 0.8rem; }
        .worker-tag button { width: auto; padding: 0; margin: 0 0 0 5px; border: none; background: none; color: red; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: var(--primary-green); }
        .money-text { font-weight: bold; color: var(--money); }
        #video-preview { width: 100%; border-radius: 10px; display: none; margin-bottom: 10px; background: #000; }
    </style>
</head>
<body>

<header>
    <h1>üçÉ Ken Farms Manager</h1>
    <p>Buyer-Specific Tea Ledger</p>
</header>

<div class="grid-container">
    <div class="card"><h3>Sasini</h3><div class="stat-val" id="total-sasini">0</div><span class="rate-badge">10/- per kg</span></div>
    <div class="card"><h3>KTDA</h3><div class="stat-val" id="total-ktda">0</div><span class="rate-badge">10/- per kg</span></div>
    <div class="card"><h3>Chemalal</h3><div class="stat-val" id="total-chemalal">0</div><span class="rate-badge">8/- per kg</span></div>
    <div class="card"><h3>Taiwet</h3><div class="stat-val" id="total-taiwet">0</div><span class="rate-badge">8/- per kg</span></div>
    <div class="card"><h3>Unilever</h3><div class="stat-val" id="total-unilever">0</div><span class="rate-badge">8/- per kg</span></div>
    <div class="card payroll-card">
        <h3>Total Monthly Payroll</h3>
        <div class="stat-val" style="color:var(--blue); font-size: 1.8rem;">Ksh <span id="total-payroll">0</span></div>
        <button class="pdf-btn" onclick="generatePDF()">üìÑ Export Official PDF</button>
    </div>
</div>

<div class="main-content">
    <div class="sidebar">
        <div class="section-box">
            <h2>Worker Registry</h2>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="newWorker" placeholder="Add Worker" style="margin:0">
                <button onclick="addWorker()" style="width: 60px; margin:0; background: var(--blue); color:white; border:none;">Add</button>
            </div>
            <div id="workerList" style="margin-top: 10px;"></div>
        </div>

        <div class="section-box">
            <h2>Record Harvest</h2>
            <video id="video-preview" autoplay playsinline></video>
            <form id="harvestForm">
                <select id="workerSelect" required><option value="">-- Select Worker --</option></select>
                <select id="buyerSelect" required>
                    <option value="sasini">Sasini (10/-)</option>
                    <option value="ktda">KTDA (10/-)</option>
                    <option value="chemalal">Chemalal (8/-)</option>
                    <option value="taiwet">Taiwet (8/-)</option>
                    <option value="unilever">Unilever (8/-)</option>
                </select>
                <input type="number" id="weight" step="0.1" placeholder="Enter Kg" required>
                <button type="submit" class="submit-btn">Save Entry</button>
            </form>
        </div>
    </div>

    <div class="section-box">
        <h2>Production History</h2>
        <div style="max-height: 500px; overflow-y: auto;">
            <table id="historyTable">
                <thead><tr><th>Date</th><th>Worker</th><th>Buyer</th><th>Kg</th><th>Pay</th><th></th></tr></thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Camera Auto-Open
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            const vid = document.getElementById('video-preview');
            vid.srcObject = stream; vid.style.display = 'block';
        } catch (e) {}
    }
    window.onload = initCamera;

    const DB_KEY = "KEN_FARMS_BUYERS_2026";
    const WORKER_KEY = "KEN_FARMS_WORKERS_2026";
    const BUYER_RATES = { sasini: 10, ktda: 10, chemalal: 8, taiwet: 8, unilever: 8 };

    let records = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let workers = JSON.parse(localStorage.getItem(WORKER_KEY)) || ["Sharon", "Daisy 2", "Chepkoech", "Doreen"];

    function addWorker() {
        const name = document.getElementById('newWorker').value.trim();
        if (name && !workers.includes(name)) {
            workers.push(name);
            localStorage.setItem(WORKER_KEY, JSON.stringify(workers));
            document.getElementById('newWorker').value = '';
            updateWorkerUI();
        }
    }

    function removeWorker(name) {
        if(confirm(`Remove ${name}?`)) {
            workers = workers.filter(w => w !== name);
            localStorage.setItem(WORKER_KEY, JSON.stringify(workers));
            updateWorkerUI();
        }
    }

    function updateWorkerUI() {
        const list = document.getElementById('workerList');
        const drop = document.getElementById('workerSelect');
        list.innerHTML = ''; drop.innerHTML = '<option value="">-- Select Worker --</option>';
        workers.sort().forEach(w => {
            list.innerHTML += `<span class="worker-tag">${w}<button onclick="removeWorker('${w}')">√ó</button></span>`;
            drop.innerHTML += `<option value="${w}">${w}</option>`;
        });
    }

    function render() {
        const body = document.getElementById('historyBody');
        body.innerHTML = '';
        let stats = { sasini: 0, ktda: 0, chemalal: 0, taiwet: 0, unilever: 0, totalPay: 0 };

        [...records].reverse().forEach(r => {
            stats[r.buyer] += r.weight;
            const pay = r.weight * r.rate;
            stats.totalPay += pay;
            body.innerHTML += `<tr>
                <td>${r.date}</td><td><strong>${r.name}</strong></td>
                <td style="text-transform:capitalize">${r.buyer}</td>
                <td>${r.weight}</td><td class="money-text">${pay.toFixed(2)}</td>
                <td><button onclick="deleteRec(${r.id})" style="color:red;border:none;background:none;cursor:pointer">√ó</button></td>
            </tr>`;
        });

        for (let b in BUYER_RATES) { document.getElementById(`total-${b}`).innerText = stats[b].toFixed(1) + " kg"; }
        document.getElementById('total-payroll').innerText = stats.totalPay.toLocaleString();
    }

    document.getElementById('harvestForm').onsubmit = function(e) {
        e.preventDefault();
        const buyer = document.getElementById('buyerSelect').value;
        records.push({
            id: Date.now(),
            name: document.getElementById('workerSelect').value,
            buyer: buyer,
            weight: parseFloat(document.getElementById('weight').value),
            rate: BUYER_RATES[buyer],
            date: new Date().toLocaleDateString()
        });
        localStorage.setItem(DB_KEY, JSON.stringify(records));
        render();
        document.getElementById('weight').value = '';
    };

    function deleteRec(id) {
        if(confirm("Delete record?")) { records = records.filter(r => r.id !== id); localStorage.setItem(DB_KEY, JSON.stringify(records)); render(); }
    }

    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tKg = records.reduce((s, r) => s + r.weight, 0);
        const tPay = records.reduce((s, r) => s + (r.weight * r.rate), 0);

        doc.setFontSize(20); doc.setTextColor(27, 94, 32);
        doc.text("KEN FARMS OFFICIAL HARVEST REPORT", 105, 20, { align: "center" });
        
        doc.autoTable({
            startY: 35,
            head: [['Date', 'Worker', 'Buyer', 'Rate', 'Weight', 'Total']],
            body: records.map(r => [r.date, r.name, r.buyer.toUpperCase(), r.rate, r.weight, (r.weight*r.rate).toFixed(2)]),
            foot: [['', '', 'GRAND TOTALS', '', `${tKg.toFixed(1)} kg`, `Ksh ${tPay.toLocaleString()}`]],
            headStyles: { fillColor: [27, 94, 32] },
            footStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold' }
        });
        doc.save("Ken_Farms_Report.pdf");
    }

    updateWorkerUI(); render();
</script>
</body>
</html>
